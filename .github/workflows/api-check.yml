name: API Check

on:
    pull_request:

jobs:
    check:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Download CLI
              env:
                  GH_TOKEN: ${{ secrets.GH_PAT }}
              run: |
                  curl -sL \
                    -H "Authorization: token ${GH_TOKEN}" \
                    -H "Accept: application/octet-stream" \
                    $(curl -s \
                      -H "Authorization: token ${GH_TOKEN}" \
                      https://api.github.com/repos/AsteriusIT/apiops-engine-cli/releases/latest \
                      | jq -r '.assets[] | select(.name == "apiops-engine-cli-linux-amd64") | .url') \
                    -o apiops-engine-cli
                  chmod +x apiops-engine-cli

            - name: Check breaking changes
              run: |
                  ./apiops-engine-cli api diff \
                    -s git:origin/main:api/openapi.yaml \
                    -t file:./api/openapi.yaml
